---
title: "Sesión 04: Regresión lineal"
author: "Juan David Ospina Arango <br> Universidad Nacional de Colombia <br> Facultad de Minas <br> Departamento de Ciencias de la Computación y de la Decisión"
date: "5/21/2020"
output: 
 html_document:
  fig_caption: yes
---

<p><span style="font-size: 12pt; font-family: helvetica;">&nbsp;&nbsp;</span></p>
<p><span style="color: #000000;"><strong><span style="font-size: 14pt; font-family: helvetica;">Modelo Lineal</span></strong></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Sea&nbsp;<img src="images/ModelolinealgeneralMAE/A.png" alt="A" width="230" height="33" />&nbsp;con xi ϵ R<sup>p</sup> y&nbsp; y<sub>i</sub>&nbsp; ϵ&nbsp; R.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Queremos predecir&nbsp;<img src="images/ModelolinealgeneralMAE/D.png" alt="D" width="31" height="32" />&nbsp;a partir de <img src="images/ModelolinealgeneralMAE/E.png" alt="E" width="42" height="34" />.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Dejamos <img src="images/ModelolinealgeneralMAE/F.png" alt="F" width="35" height="37" />como la predicción a partir de <span style="font-family: helvetica;"><img src="images/ModelolinealgeneralMAE/E.png" alt="E" width="42" height="34" />U</span>na solución es <img src="images/ModelolinealgeneralMAE/G.png" alt="G" width="207" height="48" />, el error es <img src="images/ModelolinealgeneralMAE/H.png" alt="H" width="164" height="41" />. En forma vectorial esta puede escribirse como:</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/1.png" alt="1" width="671" height="208" /></span></p>
<p style="text-align: justify;"><span style="font-family: helvetica; color: #808080; font-size: 12pt;">A partir de lo siguiente:</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/2.png" alt="2" width="73" height="86" /></span></p>
<p><span style="font-size: 12pt; color: #808080;">El vector de error es <img src="images/ModelolinealgeneralMAE/I.png" alt="I" width="117" height="40" />. Una solución para encontrar&nbsp;<img src="images/ModelolinealgeneralMAE/J.png" alt="J" width="23" height="39" /> es minimizar <img src="images/ModelolinealgeneralMAE/K.png" alt="K" width="49" height="36" />, pero esto es lo mismo que minimizar&nbsp;<img src="images/ModelolinealgeneralMAE/3.png" alt="3" width="116" height="61" />.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Así,&nbsp;<img src="images/ModelolinealgeneralMAE/4.png" alt="4" width="608" height="97" /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Observemos que:</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/5.png" alt="5" width="737" height="176" /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Luego</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/6.png" alt="6" width="508" height="146" /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Igualando esta derivada a cero se obtiene:</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/7.png" alt="7" width="485" height="64" /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">A (2) se le conoce como ecuación normal.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Observemos que <img src="images/ModelolinealgeneralMAE/8.png" alt="8" width="276" height="65" />, luego el <img src="images/ModelolinealgeneralMAE/J.png" alt="J" width="27" height="44" />que satisface (2) es un mínimo si&nbsp;<img src="images/ModelolinealgeneralMAE/9.png" alt="9" width="103" height="42" /> es definida positiva.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Como calcular&nbsp;<span style="font-family: helvetica;"><img src="images/ModelolinealgeneralMAE/J.png" alt="J" width="25" height="39" /></span> :</span></p>
<ul>
<li><span style="font-family: helvetica; color: #808080; font-size: 12pt;">1) Si <img src="images/ModelolinealgeneralMAE/10.png" alt="10" width="117" height="35" />existe entonces <img src="images/ModelolinealgeneralMAE/11.png" alt="11" width="206" height="54" />.</span></li>
<li><span style="font-family: helvetica; color: #808080; font-size: 12pt;">2) Si <span style="font-family: helvetica;"><img src="images/ModelolinealgeneralMAE/10.png" alt="10" width="117" height="35" /></span>no existe , se puede usar la pseuda-inversa. Si <img src="images/ModelolinealgeneralMAE/13.png" alt="13" />, entonces su pseudo-inversa es una matriz <img src="images/ModelolinealgeneralMAE/14.png" alt="14" />que satisface:</span></li>
<li><span style="font-size: 12pt; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/15.png" alt="15" width="700" height="47" /></span></li>
</ul>
<p><span style="font-size: 12pt; color: #808080;"></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/16.png" alt="16" width="243" height="40" />&nbsp;entonces&nbsp;<img src="images/ModelolinealgeneralMAE/17.png" alt="17" width="194" height="38" /> es la solución de mínima norma. Observemos que <img src="images/ModelolinealgeneralMAE/18.png" alt="18" width="103" height="38" />puede no existir si hay más variables que observaciones o si hay variables linealmente independientes.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Además, se puede definir con <img src="images/ModelolinealgeneralMAE/19.png" alt="19" width="257" height="36" />donde<em><span> ‖.‖</span> </em>&nbsp;es una norma matricial. Si cond (A) es muy grande, errores pequeños en los datos pueden llevar a grandes errores en la solución.</span></p>
<p><span style="font-family: helvetica; font-size: 12pt; color: #808080;">3) Una alternativa numéricamente eficiente es la descomposición QR. Se puede mostrar que si A ϵ R<sup>n*m</sup> entonces A=QR, con Q ϵ R<sup>n*n</sup> ortonormal (i.e Q<sup>T</sup> Q=I<sub>n*n</sub>) y R matriz triangular superior.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Si A ϵ R<sup>m*n</sup>, m≥n, entonces A=QR, con Q ϵ R<sup>n*m</sup> y R ϵ R<sup>m*n</sup> triangular superior.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Se puede escribir <img src="images/ModelolinealgeneralMAE/20.png" alt="20" width="114" height="41" />, con R<sub>1</sub>&nbsp; ϵ R<sup>n*n</sup>&nbsp; triangular superior y θϵ R<sup>(m-n)*n</sup> matriz de ceros.</span></p>
<p><span style="font-size: 12pt; color: #808080;"><span style="font-family: helvetica;">También se puede escribir Q= [Q<sub>1</sub> Q<sub>2</sub>] con Q<sub>1</sub>&nbsp; ϵ R<sup>m*n</sup> y Q<sub>2</sub> ϵ R<sup>m*(m-n)</sup>. Así:</span><span style="font-family: helvetica;"><br /><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/21.png" alt="21" width="326" height="74" /></span></span></p>
<p><span style="font-size: 12pt; color: #808080;"></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Esta descomposición no es única. La descomposición QR se puede hallar usando el algoritmo de Gramm-schmidt.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Para los modelos lineales se tiene X=QR con Q ϵ R<sup>n*n</sup> &nbsp;&nbsp;&nbsp;y&nbsp; <img src="images/ModelolinealgeneralMAE/22.png" alt="22" width="89" height="45" />con R<sub>1</sub> ϵ R<sup>(p+1)*(p+1)</sup> y θ ϵ R<sup>(n-p-1)*(p+1)</sup> matriz de ceros.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Observemos que&nbsp;<img src="images/ModelolinealgeneralMAE/23.png" alt="23" width="172" height="31" /> se puede escribir como R<sup>T</sup> Q<sup>T</sup> QRβ= R<sup>T</sup> Qy.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Así R<sup>T</sup> Rβ= R<sup>T</sup> Q<sup>T</sup> y, que se puede re-escribir como:</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/24.png" alt="24" width="609" height="105" />&nbsp;&nbsp;</span></p>
<p><span style="font-size: 12pt; color: #808080;"><span style="font-family: helvetica;">De esta forma R<sub>1</sub><sup>T</sup> R<sub>1</sub> β= R<sub>1</sub><sup>T</sup> Q<sub>1</sub><sup>T</sup> y. Si se define C=R<sub>1</sub>β <em><strong>y b=R<sub>1</sub><sup>T</sup> Q<sub>1</sub><sup>T</sup> </strong></em></span><span style="font-family: helvetica;"><em><strong>Y&nbsp;</strong></em></span><span style="font-family: helvetica;"><em><strong>entonces el problema se puede resolver en dos pasos:</strong></em></span></span></p>
<p><span style="font-size: 12pt; color: #808080;"><span style="font-family: helvetica;"><em><strong>&nbsp;i)</strong></em></span><span><span style="font-family: helvetica;"><em><strong>&nbsp;</strong></em></span>R<sub>1</sub><sup>T</sup> c = b se resuelve para <span style="text-decoration: underline;">c</span> (fácilmente porque R<sub>1</sub><sup>T</sup> es matriz triangular superior).</span></span></p>
<p><span style="font-size: 12pt; color: #808080;">ii) R<sub>1</sub>β = <span style="text-decoration: underline;">c</span> se resuelve para <span style="text-decoration: underline;">β</span> <em><strong>(</strong></em>fácilmente por que R<sub>1</sub> es matriz triangular superior<em><strong>).</strong></em></span></p>
<p><span style="color: #808080; font-size: 12pt;"><strong><span style="font-family: helvetica;">Cosas maravillosas</span></strong></span></p>
<p><span style="font-size: 12pt; color: #808080;">1) Si&nbsp;&nbsp;<img src="images/ModelolinealgeneralMAE/25.png" alt="25" width="204" height="33" />&nbsp;entonces&nbsp;<img src="images/ModelolinealgeneralMAE/26.png" alt="26" width="81" height="36" /> es <img src="images/ModelolinealgeneralMAE/27.png" alt="27" width="245" height="30" />. Si se define <img src="images/ModelolinealgeneralMAE/28.png" alt="28" width="206" height="24" />, entonces <img src="images/ModelolinealgeneralMAE/29.png" alt="29" width="95" height="36" />.</span></p>
<p><span style="font-size: 12pt; color: #808080;">A&nbsp;&nbsp;<img src="images/ModelolinealgeneralMAE/30.png" alt="30" width="27" height="27" />se le llama matriz sombrero porque pone un “^” sobre <img src="images/ModelolinealgeneralMAE/31.png" alt="31" width="160" height="32" />.&nbsp;&nbsp;<span style="font-family: helvetica; background-color: inherit; caret-color: auto;"><img src="images/ModelolinealgeneralMAE/30.png" alt="30" width="27" height="27" /></span>es simétrica y&nbsp;<img src="images/ModelolinealgeneralMAE/33.png" alt="33" width="108" height="33" />.</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/34.png" alt="34" width="113" height="33" />. Además&nbsp;<img src="images/ModelolinealgeneralMAE/35.png" alt="35" width="106" height="32" /> también es simétrica e idempotente.</span></p>
<p><span style="font-size: 12pt; color: #808080;">2) <img src="images/ModelolinealgeneralMAE/36.png" alt="36" width="355" height="47" />&nbsp;luego <img src="images/ModelolinealgeneralMAE/37.png" alt="37" width="476" height="38" />. Este segundo<span style="background-color: inherit; font-family: inherit; caret-color: auto;">&nbsp;resultado quiere decir </span><span style="background-color: inherit; font-family: inherit; caret-color: auto;">que se pueden conocer los errores del modelo sin conocer los coeficientes.</span></span></p>
<p><span style="font-size: 12pt; color: #808080;">3) Si se reemplaza&nbsp;<img style="background-color: inherit; color: #808080; font-family: helvetica; font-size: 12pt; caret-color: auto;" src="images/ModelolinealgeneralMAE/M.png" alt="M" width="28" height="38" /><span style="background-color: inherit; font-family: helvetica; caret-color: auto;"> por&nbsp;</span><img style="background-color: inherit; color: #808080; font-family: helvetica; font-size: 12pt; caret-color: auto;" src="images/ModelolinealgeneralMAE/38.png" alt="38" width="56" height="35" /><span style="background-color: inherit; font-family: helvetica; caret-color: auto;"> y luego&nbsp;</span><img style="background-color: inherit; color: #808080; font-family: helvetica; font-size: 12pt; caret-color: auto;" src="images/ModelolinealgeneralMAE/J.png" alt="J" width="25" height="44" /><span style="background-color: inherit; font-family: helvetica; caret-color: auto;">&nbsp;&nbsp;por </span><img style="background-color: inherit; color: #808080; font-family: helvetica; font-size: 12pt; caret-color: auto;" src="images/ModelolinealgeneralMAE/39.png" alt="39" width="106" height="33" /><span style="background-color: inherit; font-family: helvetica; caret-color: auto;">es la función de costo se tiene:</span></span></p>
<p style="text-align: center;"><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/40.png" alt="40" width="664" height="275" /></span></p>
<p style="text-align: left;"><span style="font-size: 12pt; color: #808080;">Luego el valor mínimo del error cuadrático medio también se puede conocer antes de calcular <img style="background-color: inherit; color: #808080; font-family: helvetica; font-size: 12pt; caret-color: auto;" src="images/ModelolinealgeneralMAE/J.png" alt="J" width="26" height="43" /><span style="background-color: inherit; font-family: helvetica; caret-color: auto;">.</span></span></p>
<p><span style="font-size: 12pt; color: #808080;"></span></p>
<p><span style="font-size: 12pt; color: #808080;"></span></p>
<p><span style="font-size: 12pt; color: #808080;"><strong><span style="font-family: helvetica;">Propiedades distribucionales</span></strong></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Si <em><span>y<sub>i</sub>=β<sub>0</sub>+x<sub>i</sub><sup>T</sup> βx+ε<sub>i</sub></span></em> &nbsp;con&nbsp;<img src="images/ModelolinealgeneralMAE/41.png" alt="41" width="224" height="42" /> entonces <img src="images/ModelolinealgeneralMAE/42.png" alt="42" width="172" height="40" />, con <img src="images/ModelolinealgeneralMAE/43.png" alt="43" width="216" height="43" />.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Luego <img src="images/ModelolinealgeneralMAE/44.png" alt="44" width="286" height="45" />.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Como <img src="images/ModelolinealgeneralMAE/45.png" alt="45" width="241" height="43" />, entonces&nbsp; <img src="images/ModelolinealgeneralMAE/J.png" alt="J" width="26" height="44" />&nbsp; sigue una distribución normal&nbsp;<img src="images/ModelolinealgeneralMAE/N.png" alt="N" width="73" height="35" /> &nbsp;variada con</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/46.png" alt="46" width="675" height="302" /><br /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Además, como&nbsp;<img src="images/ModelolinealgeneralMAE/47.png" alt="47" width="239" height="39" /></span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="float: left;" src="images/ModelolinealgeneralMAE/48.png" alt="48" width="671" height="155" /></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="font-size: 12pt; color: #808080;"><strong><span style="font-family: helvetica;">Leverage</span></strong></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/49.png" alt="49" width="231" height="58" />&nbsp;luego&nbsp;<img src="images/ModelolinealgeneralMAE/50.png" alt="50" width="131" height="54" />&nbsp;es tal que <img src="images/ModelolinealgeneralMAE/51.png" alt="51" width="103" height="56" />. A <em><span>h<sub>ii</sub></span></em> se le denomina leverage.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Un valor de<em><span> h<sub>ii</sub></span></em> muy alto implica que pequeños centros en y<sub>i</sub> <sub>&nbsp;&nbsp;</sub>provocan grandes centros en <img src="images/ModelolinealgeneralMAE/F.png" alt="F" width="33" height="35" />.</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Los puntos con alto leverage son sospechosos de ser atípicos. Un alto leverage indica un valor extraño para y<sub>i</sub>.</span></p>
<p><span style="font-size: 12pt; color: #808080;"><strong><span style="font-family: helvetica;">Puntos influyentes</span></strong></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Son aquellos que tienen un alto impacto en <img src="images/ModelolinealgeneralMAE/J.png" alt="J" width="24" height="39" />. Se pueden encontrar con las distancias de Cook D<sub>i</sub>:</span></p>
<p style="text-align: center;"><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/52.png" alt="52" width="644" height="131" /><br /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">y&nbsp; <img src="images/ModelolinealgeneralMAE/R.png" alt="R" width="63" height="48" />es la predicción para <em><span>y<sub>j</sub></span></em> &nbsp;a partir de un modelo estimado con la muestra&nbsp;<img src="images/ModelolinealgeneralMAE/S.png" alt="S" width="192" height="43" /> &nbsp;.</span></p>
<p><span style="color: #808080; font-size: 12pt;"><strong><span style="font-family: helvetica;">Residuales</span></strong></span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="float: left;" src="images/ModelolinealgeneralMAE/53.png" alt="53" width="652" height="97" /></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Se define el residual estudentizado <em><span>t<sub>i</sub></span></em> como</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/54.png" alt="54" width="646" height="70" /></span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;">Usando <span><em>t<sub>i</sub></em></span>, puede escribirse<em><span> D<sub>i</sub></span></em> como:</span></p>
<p><span style="font-family: helvetica; color: #808080; font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/55.png" alt="55" width="243" height="98" />.&nbsp;&nbsp;&nbsp;</span></p>
<p><span style="font-size: 12pt; color: #808080;"><strong><span style="font-family: helvetica;">Diagnósticos</span></strong></span></p>
<p><span style="font-size: 12pt; color: #808080;">1) Residuales (y) VS ajustados (x).</span></p>
<p><span style="font-size: 12pt; color: #808080;">2) Normal Q-Q plot: percentiles de los residuales estandarizados VS los de la normal estándar.</span></p>
<p><span style="font-size: 12pt; color: #808080;">3) Localización – Escala:&nbsp;<img src="images/ModelolinealgeneralMAE/56.png" alt="56" width="212" height="39" /> (y) VS ajustados (x).</span></p>
<p><span style="font-size: 12pt; color: #808080;">4) Residuales (y) VS Leverage (x): <em><span>t<sub>i</sub></span></em> VS <em><span>h<sub>ii</sub></span></em></span></p>
<p><span style="font-size: 12pt; color: #808080;">5) Distancia de Cook.</span></p>
<p><span style="font-size: 12pt; color: #808080;"></span></p>
<p><span style="color: #808080; font-size: 12pt;"><strong><span style="font-family: helvetica;">Prueba de hipótesis</span></strong></span></p>
<p><span style="font-size: 12pt; color: #808080;">1) Significancia de la regresión</span></p>
<p><span style="font-size: 12pt; color: #808080;">Total son ejemplos Squares SST</span></p>
<p><span style="font-size: 12pt; color: #808080;"><img style="float: left;" src="images/ModelolinealgeneralMAE/57.png" alt="57" width="640" height="282" /></span></p>
<ul>
<li></li>
</ul>
<p>&nbsp;</p>
<ul>
<li><span style="font-size: 12pt; color: #808080;">a) De las ecuaciones normales se tiene:</span></li>
<li style="text-align: justify;"><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/58.png" alt="58" width="655" height="140" /></span></li>
<li></li>
<li style="text-align: justify;"><span style="font-size: 12pt; color: #808080;">b) Como <img src="images/ModelolinealgeneralMAE/59.png" alt="59" width="126" height="40" />, entonces <img src="images/ModelolinealgeneralMAE/60.png" alt="60" width="126" height="48" />, donde&nbsp;<img src="images/ModelolinealgeneralMAE/61.png" alt="61" />&nbsp;<span style="background-color: inherit; font-family: inherit; caret-color: auto;">Es la i-ésima columna de </span><span style="background-color: inherit; caret-color: auto; font-family: helvetica;"><img src="images/ModelolinealgeneralMAE/61.png" alt="61" /></span><span style="background-color: inherit; font-family: inherit; caret-color: auto;">. En particular </span><img style="color: #808080; font-size: 12pt; background-color: inherit; font-family: inherit; caret-color: auto;" src="images/ModelolinealgeneralMAE/63.png" alt="63" width="101" height="44" /><span style="background-color: inherit; font-family: inherit; caret-color: auto;">, luego&nbsp;</span><img style="color: #808080; font-size: 12pt; background-color: inherit; font-family: inherit; caret-color: auto;" src="images/ModelolinealgeneralMAE/64.png" alt="64" width="116" height="38" /><span style="background-color: inherit; font-family: inherit; caret-color: auto;"> .</span></span></li>
<li><span style="font-size: 12pt; color: #808080;"></span></li>
<li><span style="color: #808080; font-size: 12pt;">De esta manera la suma de cuadrados totales se puede escribir como:</span></li>
<li><span style="color: #808080; font-size: 12pt;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/65.png" alt="65" width="600" height="103" /></span></li>
<li><span style="color: #808080; font-size: 12pt;">SST tiene <em style="color: #808080; font-size: 12pt; background-color: inherit; font-family: inherit; caret-color: auto;"><span>n-1</span></em><span style="background-color: inherit; font-family: inherit; caret-color: auto;"> grados de libertad.</span></span></li>
<li><span style="color: #808080; font-size: 12pt;">SSR (Suma de cuadrados del modelo) tiene p grados de libertad.</span></li>
<li><span style="color: #808080; font-size: 12pt;">SSE (Suma de Cuadrados del Error) tiene<em><span> n-p-1</span></em> grados de libertad.</span></li>
<li><span style="font-size: 12pt; color: #808080;"></span></li>
<li><span style="color: #808080; font-size: 12pt;">En forma vectorial</span></li>
<li><span style="color: #808080; font-size: 12pt;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/66.png" alt="66" width="719" height="273" /></span></li>
<li><span style="color: #808080; font-size: 12pt;">(*) Observemos que <img src="images/ModelolinealgeneralMAE/67.png" alt="67" width="154" height="59" />, luego&nbsp;<img src="images/ModelolinealgeneralMAE/68.png" alt="68" width="404" height="58" /></span></li>
<li><span style="color: #808080; font-size: 12pt;">.</span></li>
<li><span style="font-size: 12pt; color: #808080;"></span></li>
<li><span style="color: #808080; font-size: 12pt;">En forma vectorial SSE es&nbsp;</span></li>
<li><span style="color: #808080; font-size: 12pt;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/69.png" alt="69" width="383" height="179" /></span></li>
<li><span style="font-size: 12pt; color: #808080;"></span></li>
<li><span style="color: #808080; font-size: 12pt;">En forma vectorial SSR es:&nbsp;</span></li>
<li><span style="color: #808080; font-size: 12pt;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/70.png" alt="70" width="484" height="236" /></span></li>
<li><span style="color: #808080; font-size: 12pt;">(*) Se utiliza el hecho de que <img src="images/ModelolinealgeneralMAE/71.png" alt="71" width="195" height="54" />, lo que se deduce del hecho de que <img src="images/ModelolinealgeneralMAE/72.png" alt="72" width="135" height="38" />.</span></li>
<li><span style="font-size: 12pt; color: #808080;"></span></li>
<li><span style="color: #808080; font-size: 12pt;">Así <em><span>SST= SSR + SSE</span></em> implica que</span></li>
<li><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/73.png" alt="73" width="702" height="59" /></span></li>
<li><span style="font-size: 12pt; color: #808080;">SST se interpreta como la desviación de la y<sub style="color: #808080; font-family: helvetica; background-color: inherit; caret-color: auto;">i</sub><span style="font-family: helvetica; background-color: inherit; caret-color: auto;"> de su valor promedio </span><img style="color: #808080; font-family: helvetica; font-size: 12pt; background-color: inherit; caret-color: auto;" src="images/ModelolinealgeneralMAE/M.png" alt="M" width="26" height="36" /><span style="font-family: helvetica; background-color: inherit; caret-color: auto;">.</span></span></li>
<li><span style="color: #808080; font-size: 12pt; font-family: helvetica;">SSR se interpreta como la diferencia entre las predicciones del modelo lineal y aquellas del modelo nulo (solo tiene de intercepto <img src="images/ModelolinealgeneralMAE/P.png" alt="P" width="93" height="38" />).</span></li>
</ul>
<ul>
<li><span style="color: #808080; font-size: 12pt; font-family: helvetica;">SSE es la diferencia entre los valores predichos por el modelo y los observados.</span></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">Un valor de SSR pequeño indica que el modelo no hace mucho comparado con el modelo nulo.</span></li>
<li></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">Se puede definir</span></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;"><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/74.png" alt="74" width="464" height="72" /></span></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">El MSE es un estimador de&nbsp;<img src="images/ModelolinealgeneralMAE/75.png" alt="75" /></span></li>
<li></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">Cuando<span style="font-size: 14pt;"><em> βx≈0</em></span>, entonces&nbsp;&nbsp;y SSR≈0, luego <span style="font-size: 14pt;"><em>SST≈SSE</em></span>. Se define el estadístico <span style="font-size: 14pt;"><em>F<sub style="color: #888888; text-align: justify; background-color: inherit; font-family: inherit; caret-color: auto;">0</sub></em></span><span style="text-align: justify; background-color: inherit; caret-color: auto;"><span style="font-size: 14pt;"><em>= MSR /MSE</em></span> para probar la hipótesis nula <img src="images/ModelolinealgeneralMAE/76.png" alt="76" width="335" height="43" /></span></span></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;"><span style="text-align: justify; background-color: inherit; caret-color: auto;">Se rechaza <span style="font-size: 14pt;"><em>H<sub style="color: #808080; font-family: helvetica; background-color: inherit; caret-color: auto;">0</sub></em></span><span style="background-color: inherit; caret-color: auto;"> para valores grandes de <em><span style="font-size: 14pt;">F</span></em></span><sub style="color: #808080; font-family: helvetica; background-color: inherit; caret-color: auto;"><em><span style="font-size: 14pt;">0</span></em>. </sub><span style="background-color: inherit; caret-color: auto;">Bajo&nbsp;</span></span><span style="font-size: 14pt;"><em>H<sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">0</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;"> F</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">0</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;"> ~ F</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">p,n-p-1</sub></em></span><span style="text-align: justify; background-color: inherit; caret-color: auto;"><span style="font-size: 14pt;"><em>-</em></span>. Luego se rechaza <em><span style="font-size: 14pt;">H</span></em></span><em><span style="font-size: 14pt;"><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">0</sub></span></em><span style="text-align: justify; background-color: inherit; caret-color: auto;"> a nivel α si <span style="font-size: 14pt;"><em>F</em></span></span><span style="font-size: 14pt;"><em><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">0</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;"> &gt; </span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">F1-α, p, n-p-1</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;">.</span></em></span></span></li>
<li></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">Se pueden probar las p hipótesis&nbsp;<img src="images/ModelolinealgeneralMAE/77.png" alt="77" width="382" height="54" /></span></li>
<li><span style="font-size: 12pt; font-family: helvetica; color: #808080;">Para eso se define el estadístico <img src="images/ModelolinealgeneralMAE/78.png" alt="78" width="301" height="90" />, con&nbsp; t<sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">i</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;"> ~ t</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">n-p-1.</sub></span></li>
<li></li>
<li></li>
<li><span style="color: #000000;"><strong><span style="font-size: 14pt;">La matriz H</span></strong></span></li>
<li><span style="font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/79.png" alt="79" width="639" height="263" /></span></li>
<li></li>
<li><span style="color: #808080; font-size: 12pt;"><span style="font-family: helvetica;">Para<em><span style="font-size: 14pt;"> A ϵ R<sup style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">n*n</sup></span><span style="text-align: justify; background-color: inherit; caret-color: auto;">, <span style="font-size: 14pt;">A*A= A</span></span><span style="font-size: 14pt;"><sup style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">2</sup><span style="text-align: justify; background-color: inherit; caret-color: auto;">=B=(b</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">ij</sub><span style="text-align: justify; background-color: inherit; caret-color: auto;">)</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">ij</sub></span></em></span><span style="font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;"> con<img src="images/ModelolinealgeneralMAE/80.png" alt="80" width="218" height="48" />&nbsp;. Si<em><span style="font-size: 14pt;"> i=j</span>,</em> entonces.&nbsp;<img src="images/ModelolinealgeneralMAE/81.png" alt="81" /></span></span></li>
<li></li>
<li><span style="color: #808080; font-family: helvetica; font-size: 12pt; text-align: justify; background-color: inherit; caret-color: auto;">Si A es simétrica entonces&nbsp;<span style="font-size: 14pt;"><em> a<sub style="background-color: inherit; caret-color: auto;">ik</sub><span style="background-color: inherit; caret-color: auto;">=a</span><sub style="background-color: inherit; caret-color: auto;">ki</sub></em></span><span style="background-color: inherit; caret-color: auto;"> &nbsp;y&nbsp;<img src="images/ModelolinealgeneralMAE/82.png" alt="82" width="391" height="46" /></span></span></li>
<li></li>
<li></li>
<li><span style="color: #808080; font-size: 12pt;">Si <span style="font-size: 14pt;"><em>A=AA</em></span>, entonces&nbsp;<img src="images/ModelolinealgeneralMAE/83.png" alt="83" width="318" height="43" /> .</span></li>
<li></li>
<li><span style="color: #808080; font-size: 12pt;">Como&nbsp;<img src="images/ModelolinealgeneralMAE/84.png" alt="83" width="203" height="40" />&nbsp;entonces <img src="images/ModelolinealgeneralMAE/85.png" alt="85" />, de donde <img src="images/ModelolinealgeneralMAE/86.png" alt="86" width="159" height="36" />.</span></li>
<li></li>
<li><span style="font-size: 12pt;">De lo anterior se tiene que&nbsp;<img src="images/ModelolinealgeneralMAE/87.png" alt="87" width="116" height="49" />&nbsp; y&nbsp;&nbsp;<img src="images/ModelolinealgeneralMAE/88.png" alt="88" width="138" height="51" />.</span></li>
<li></li>
<li><span style="font-size: 12pt;">¿Cuál es el efecto de tener observaciones duplicadas?</span></li>
<li></li>
<li><span style="font-size: 12pt; color: #808080;"><img src="images/ModelolinealgeneralMAE/89.png" alt="89" width="694" height="166" /></span></li>
<li></li>
<li><span style="font-size: 12pt; color: #808080;">Pero si <img src="images/ModelolinealgeneralMAE/90.png" alt="90" width="144" height="41" />, entonces&nbsp;<img src="images/ModelolinealgeneralMAE/91.png" alt="91" width="153" height="39" /> y se tiene que <img src="images/ModelolinealgeneralMAE/92.png" alt="92" width="414" height="39" />, de donde&nbsp;<img src="images/ModelolinealgeneralMAE/93.png" alt="93" width="192" height="40" /> y así&nbsp;<img src="images/ModelolinealgeneralMAE/94.png" alt="94" width="183" height="37" /> , de donde <img src="images/ModelolinealgeneralMAE/95.png" alt="95" width="113" height="38" />. Es decir que el duplicar un vector de características su leverage se divide por 2. Observemos que se asume que <em><span style="font-size: 14pt;">x<sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">i</sub><span style="font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">=x</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">j</sub></span></em><span style="font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">, pero no que <em><span style="font-size: 14pt;">y</span></em></span><em><span style="font-size: 14pt;"><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">i</sub><span style="font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">=y</span><sub style="color: #808080; font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">j</sub></span></em><span style="font-family: helvetica; text-align: justify; background-color: inherit; caret-color: auto;">,</span></span></li>
<li></li>
<li></li>
<li><span style="color: #000000;"><strong><span style="font-size: 14pt; font-family: helvetica;">El <em>R<sup style="color: #888888; text-align: justify; background-color: inherit; font-family: inherit; caret-color: auto;">2</sup></em><span style="text-align: justify; background-color: inherit; caret-color: auto;">, <em>C</em></span><em><sub style="color: #888888; text-align: justify; background-color: inherit; font-family: inherit; caret-color: auto;">P</sub></em><span style="text-align: justify; background-color: inherit; caret-color: auto;">, AIC Y BIC</span></span></strong></span></li>
<li></li>
<li><span style="font-size: 12pt;">Se define como</span></li>
<li>&nbsp;<img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/96.png" alt="96" width="501" height="121" /></li>
<li><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/97.png" alt="97" width="610" height="341" /><span style="font-size: 14pt; font-family: helvetica; color: #000000;"></span></li>
<li><strong><span style="font-size: 14pt; font-family: helvetica; color: #000000;">Inflación de la varianza</span></strong></li>
<li></li>
<li><img style="display: block; margin-left: auto; margin-right: auto;" src="images/ModelolinealgeneralMAE/99.png" alt="99" width="328" height="83" /></li>
<li><span style="font-size: 12pt;"><img src="images/ModelolinealgeneralMAE/100.png" alt="100" width="110" height="43" />es el <em><span style="font-size: 14pt;">R<sup>2</sup> </span></em>de la regresión donde <em><span style="font-size: 14pt;">x<sub>j</sub> </span></em>es la variable respuesta y todos los otros predictores son variables explicativas.</span></li>
</ul>
<p><span style="font-size: 12pt; font-family: helvetica;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>
<p>&nbsp;</p>
<p><span style="font-family: helvetica; color: #000000;"><strong><span style="font-size: 14pt;">Coeficientes</span></strong></span></p>
<p><span style="color: #000000;"><strong><span style="font-family: helvetica; font-size: 14pt;">Modelos Lineales</span></strong></span></p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="images/Coeficientes/1.png" alt="1" width="655" height="133" /></p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="images/Coeficientes/2.png" alt="2" width="656" height="79" /></p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="images/Coeficientes/3.png" alt="3" width="566" height="61" /></p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="images/Coeficientes/4.png" alt="4" width="643" height="97" />&nbsp;</p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="images/Coeficientes/5.png" alt="5" width="537" height="279" /></p>
<p><span style="font-size: 12pt; font-family: helvetica;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Modelos lineales para problemas no lineales

En esta sesión se usa un modelo lineal para modelar un fenómeno lineal: los precios de la vivienda en Taiwan. El conjunto de datos es [Real estate valuation data set Data Set](http://archive.ics.uci.edu/ml/datasets/Real+estate+valuation+data+set).

**Citación:** Yeh, I. C., & Hsu, T. K. (2018). Building real estate valuation models with comparative approach through case-based reasoning. Applied Soft Computing, 65, 260-271.

Se comienza con la lectura de los datos:

```{r}
datos <- read.csv2("real_estate_valuation_dataset.csv")
```

A continuación se inspecciona visualmente el conjunto de datos con la función `head()`:

```{r}
head(datos)
```

La definición de las variables es la siguiente:

* X1: fecha de la transacción (por ejemplo 2013.250=2013 Marzo, * 2013.500=2013 Junio, etc.) 
* X2: edad de la casa en años
* X3: distancial al MRT (transporte masivo) más cercano en metros 
* X4: número de tiendas de conveniencia en el vecindario (entero)
* X5: latitud (unidad: grados) 
* X6: longitude (unidad: grados) 
* Y: precio por unidad de área (10000 Nuevos dólares taiwaneses/ 3.3 $m^2$) 


Para este problema se seleccionan solo las variables `X2`, `X3`, `X4` y `Y`:

```{r}
datos_an<-subset(datos,select = c("X2","X3","X4","Y"))
head(datos_an)
```

Veamos un resumen de los datos con la función `summary()`:

```{r}
summary(datos_an)
```

Ahora se muestran 
```{r}
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...)
{
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y,use="na.or.complete"))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

pairs(datos_an, lower.panel = panel.smooth, upper.panel = panel.cor)
```

#### Transformación de variables

Ahora se explora la pertinencia de una transformación logarítmica:


```{r}
par(mfrow=c(1,3))
plot(datos_an$X2+1,datos_an$Y,log="xy", # la respuesta en escala logarítmica
     xlab="Edad de la casa [ln(1+años)]",
     ylab="Precio [ln ($/m2)]")
plot(datos_an$X3,datos_an$Y,log="xy",
     xlab="Distancia al MRT [ln m]",
     ylab="Precio [ln ($/m2)]")
plot(datos_an$X4+1,datos_an$Y,log="yx",
     xlab="Comercios de conveniencia cercanos [ln(1+n)]",
     ylab="Precio [ln ($/m2)]")
```

El siguiente código crea las variables transformadas:

```{r}
datos_an$X2log<-log(datos_an$X2+1) #ln(1+x)
datos_an$X3log<-log(datos_an$X3) # ln(x)
datos_an$X4log<-log(datos_an$X4+1) #ln(1+x)
datos_an$Ylog<-log(datos_an$Y) # ln(x)
```


Ahora se muestran las dispersiones por pares incluyendo las variables transformadas:

```{r}
pairs(datos_an, lower.panel = panel.smooth, upper.panel = panel.cor, 
      main="Dispersión por pares con variables transformadas")
```

¿Qué permite concluir el gráfico anterior sobre la transformación de variables?


### Escalamiento de las variables: 

El siguiente código centra las variables en su respectiva media y las divide por su desviación estándar:

```{r}
datos_an_scale<-scale(datos_an,center = TRUE,scale = TRUE)
medias<-attr(datos_an_scale,"scaled:center") # se guarda la media para procesos posteriores
desv_est<-attr(datos_an_scale,"scaled:scale") # se guarda la sd para procesos posteriores
datos_an_scale<-as.data.frame(datos_an_scale) # los datos escalados se ponen en un dataframe
```

A continuación se muestra el gráfico de dispersión por pares de los datos escalados:

```{r}
pairs(datos_an_scale, lower.panel = panel.smooth, upper.panel = panel.cor, 
      main="Dispersión por pares con variables transformadas y escaladas")
```

### Calibración de un modelo lineal

Primero se separa el conjunto de datos en entrenamiento y validación:

```{r}
set.seed(20200521)
p_vl<-0.2
N<-dim(datos_an)[1]
ix_vl<-sample(N,round(0.2*N),replace = FALSE)
datos_tr<-datos_an_scale[-ix_vl,]
datos_vl<-datos_an_scale[ix_vl,]
```




#### Ajuste de un modelo lineal con interacciones

El siguiente código muestra el ajuste de un modelo lineal con interacciones usando las variables en escala logarítmica y estandarizadas:

```{r}
modelo1<-lm(Ylog~-1+X2log+X3log+X4log+X4log:X3log,data=datos_tr)
summary(modelo1)
```


##### Gráficos diagnósticos

Residuales versus valores predichos:

```{r}
plot(modelo1,which=1)
```

Gráfico cuantil-cuantil de los residuales estandarizados vs los de una distribución normal:

```{r}
plot(modelo1,which=2)
```

Residuales estandarizados versus valores predichos:

```{r}
plot(modelo1,which=3)
```

Distancia de Cook de cada observación:

```{r}
plot(modelo1,which=4)
```

Residuales estandarizados versus leverage:

```{r}
plot(modelo1,which=5)
```

Distancia de Cook vs Leverage:

```{r}
plot(modelo1,which=6)
```

#### Ajuste de un modelo lineal sin interacciones

El siguiente código ajusta un modelo lineal sin interacciones:

```{r}
modelo2<-lm(Ylog~-1+X2log+X3log+X4log,data=datos_tr)
summary(modelo2)
```

Para comparar ambos modelos podemos usar la función `anova()`:

```{r}
anova(modelo2,modelo1)
```

De acuerdo a la prueba anterior, la interacción sí le aporta al modelo.

### Construcción de la función de predicción en la escala natural

El siguiente código calcula los parámetros del modelo en la escala natural de las variables. Es decir, calcula los parámetros de un modelo no lineal (las explicaciones se dan en la clase):

```{r}
m1coef<-coef(modelo1) # extrae los coeficientes
b2s<-m1coef[1]
b3s<-m1coef[2]
b4s<-m1coef[3]
b34s<-m1coef[4]
b2p<-b2s*desv_est[8]/desv_est[5]
b3p<-b3s*desv_est[8]/desv_est[6]
b4p<-b4s*desv_est[8]/desv_est[7]
b34p<-b34s*desv_est[8]/(desv_est[6]*desv_est[7])
sigma<-summary(modelo1)$sigma
b0<-medias[8]-b2p*medias[5]-b3p*medias[6]-b4p*medias[7]+b34p*medias[6]*medias[7]#+((sigma)^2)/2
b3<-b3p-b34p*medias[7]
b4<-b4p-b34p*medias[6]
b<-c(b0,b2p,b3,b4,b34p) # ector con los coeficientes del modelo no lineal
```


En el siguiente código se define la función de predicción:

```{r}
fn_pred=function(x,b){
  # Función de predicción derivada de un modelo lineal con variables con
  # transformación logarítimica y centradas
  y<-exp(b[1])*((x[1]+1)^b[2])*(x[2]^b[3])*((x[3]+1)^b[4])*((x[3]+1)^(b[5]*log(x[2])))
  return(y)
}
```

El siguiente código lleva a cabo una prueba de escritorio de la función de predicción:

```{r}
x0<-datos_tr[1,1:3]*desv_est[1:3]+medias[1:3] # este paso multiplica por la sd y suma la media
x1<-(datos_an[-ix_vl,1:3])[1,]
(fn_pred(x0,b))
(fn_pred(x0,b))
```
Cálculo de los valores predichos en entrenamiento:

```{r}
y_pred_tr<-apply(datos_an[-ix_vl,1:3],1,fn_pred,b=b)
```

```{r}
plot(datos_an$Y[-ix_vl],y_pred_tr,ylab="Predichos",xlab="Observados",
     xlim=c(0,120),ylim=c(0,120),las=1,
     main="Predichos vs observados (Entrenamiento)")
abline(a=0,b=1,lwd=2,col="red")
R_tr<-cor(datos_an$Y[-ix_vl],y_pred_tr)
R_tr<-format(R_tr,digits = 2)
rmse_tr<-sqrt(mean(datos_an$Y[-ix_vl]-y_pred_tr)^2)
rmse_tr<-format(rmse_tr,digits = 2,nsmall = 2)
grid()
legend("topleft",legend=paste0(c("Cor: ","RMSE: "),c(R_tr,rmse_tr)), bty="n")
```

Cálculo de los valores predichos para el conjunto de validación:

```{r}
y_pred_vl<-apply(datos_an[ix_vl,1:3],1,fn_pred,b=b)
```

```{r}
plot(datos_an$Y[ix_vl],y_pred_vl,ylab="Predichos",xlab="Observados",
     xlim=c(0,120),ylim=c(0,120),las=1,
     main="Predichos vs observados (Validación)")
abline(a=0,b=1,lwd=2,col="red")
R_vl<-cor(datos_an$Y[ix_vl],y_pred_vl)
R_vl<-format(R_vl,digits = 2)
rmse_vl<-sqrt(mean(datos_an$Y[ix_vl]-y_pred_vl)^2)
rmse_vl<-format(rmse_vl,digits = 2,nsmall = 2)
grid()
legend("topleft",legend=paste0(c("Cor: ","RMSE: "),c(R_vl,rmse_vl)), bty="n")
```

### Construcción de la superficile de respuesta


Primero se generara una superficie de respuesta que depende de las variables `X2` y `X3` y para la cual se considerará un valor fijo para `X4`.

El siguiente código crea los puntos en los que se evaluará la superficie de respuesta:

```{r}
X2<-seq(0,43.8,length.out=100)
X3<-seq(23.4,6488,length.out = 100)
# X4<-0:10
newdata<-expand.grid(X2,X3)
names(newdata)<-c("X2","X3")
```

El código anterior produjo el dataframe `newdata` con los valores sobre los que se quiere evaluar la superficie de respuesta. A continuación se agrega un valor fijo para la variable `X4` (se fija en 5) y se calcula la respuesta para todos los puntos:

```{r}
X4_0<-5 # referencia para X4
newdata$X4<-X4_0
newdata$Y<-apply(newdata,1,fn_pred,b=b)
```

A continuación se representa los valores de la superficie de respuesta en una matriz `z`:

```{r}
z<-matrix(newdata$Y,ncol=length(X2),nrow = length(X3))
```

Con la matriz anterior se puede visualizar la superficie de respuesta con la función `image()`:

```{r}
par(mar=c(6,8,4,2),mgp=c(5,1,0))
z_img<-t(z)
image(z_img,xaxt='n',yaxt='n',xlab="Distancia al MRT [m]",ylab="Edad (años)",col=gray.colors(8,rev=TRUE))
title(main=c("Representación de la superficie", "de respuesta en función de X2 y X3","(X4=5)"),
      sub="X4=5")
labelsX2<-format(X2, digits = 1,decimal.mark = ".",big.mark = " ")
labelsX3<-format(X3, digits = 1,decimal.mark = ".",big.mark = " ")
axis(2,at=seq(0,1,by=1/(length(X2)-1)),labels =labelsX2,las=2)
axis(1,at=seq(0,1,by=1/(length(X3)-1)),labels = labelsX3,las=2)
```


```{r}
contour(X2,X3,z,las=1,
        ylab="Distancia al MRT [m]",
        xlab="Edad (años)",
        main=c("Representación de las curvas de nivel de la superficie", "de respuesta en función de X2 y X3 (X4=5)"))
```

A continuación se presenta la superficie de respuesta en 3D estática:

```{r}
persp(X2,X3,z,xlab="Edad de la casa",ylab="Distancia al MRT",zlab="Precio",main="Superficie de respuesta para un modelo con dos variables",theta=120,shade=0.25,sub="X4=5")
```

El siguiente código presenta la superficie de respuesta 3D con 
`plotly`:

```{r message=FALSE}
library(plotly)
Z<-z
p<- plot_ly(x=X2,y=X3,z = z) 
p<- add_surface(p)
p<-layout(p,title='Precio vs dis MRT y número de comercios (X4=5)',
          scene = list(
            camera=list(eye = list(x=1.87, y=0.88, z=-0.64)),
                        xaxis=list(title="X1"),
                        yaxis=list(title="X2"),
                        zaxis=list(title="Precio ($/m2)")
                        ))
p
```

### Intervalos de predicción

#### Univariados

Se creará un intervalo de predicción en función de la variable distancia al MRT (`X2`) para una casa que tenga 3 años de antigüedad y tenga cinco tiendas alrededor. Para ello se dan los siguientes pasos:

Se crea un dataframe con los valores de las variables explicativas sobre los que se calcularán las predicciones y sus intervalos:

```{r}
datos_inter<-data.frame(X2=3,X3=X3,X4=5) 
```

Se aplican las mismas transformaciones que requiere el modelo. La primera es la tranformación logarítmica:

```{r}
datos_inter$X2log<-log(datos_inter$X2+1) #ln(1+x)
datos_inter$X3log<-log(datos_inter$X3) # ln(x)
datos_inter$X4log<-log(datos_inter$X4+1) #ln(1+x)
```

La segunda es el escalamiento:

```{r}
datos_inter_scaled<-scale(datos_inter,
                          center=medias[-c(4,8)], # se quitan los valores de Y y Ylog
                          scale = desv_est[-c(4,8)]# se quitan los valores de Y y Ylog
                          )
datos_inter_scaled<-as.data.frame(datos_inter_scaled)
```


Ahora se pueden utilizar los datos para hacer la predicción:

```{r}
pred_int<-predict(modelo1, newdata = datos_inter_scaled, interval = 'prediction')
pred_int<-as.data.frame(pred_int)
```

```{r}
ymin<-min(pred_int)
ymax<-max(pred_int)
plot(datos_inter_scaled$X3log,pred_int$fit,las=1,type="l",
     col="red",ylim=c(ymin,ymax),xlab="ln(X3) estandarizada",
     ylab="ln(Precio) estandarizado")
lines(datos_inter_scaled$X3log,pred_int$lwr,col="blue",lty=2)
lines(datos_inter_scaled$X3log,pred_int$upr,col="blue",lty=2)
legend("topright",col=c("red","blue"),lty=1:2,legend=c("Predicción","95%CI"))
```


```{r}
pred_int_escalanatural<-exp(pred_int*desv_est[8]+medias[8])
```

```{r}
ymin<-min(pred_int_escalanatural)
ymax<-max(pred_int_escalanatural)
plot(X3,pred_int_escalanatural$fit,las=1,type="l",
     col="red",ylim=c(ymin,ymax),xlab="Distancia al MRT [m]",
     ylab="Precio [$/m2]",
     main=c("Precios vs distancia al MRT","Edad: 3 años, Tiendas: 5"))
lines(X3,pred_int_escalanatural$lwr,col="blue",lty=2)
lines(X3,pred_int_escalanatural$upr,col="blue",lty=2)
grid()
legend("topright",col=c("red","blue"),lty=1:2,
       legend=c("Predicción","95%CI"))
```


## Actividades:

1. Genere un gif animado con las superficies de respuesta para los distintos valores de X4
2. Genere un video que muestre rotando las diferentes superficies para los distintos valores de X4
3. Cree un intervalo de predicción para los precios en función del número de tiendas asumiendo que las casas tienen 3 años y están a 1000 m del MRT
4. Visualice los datos atípicos en un mapa


Solución al punto 4

```{r}
library(rgdal)
library(leaflet)
library(leaflet.extras)
```

```{r}
CD<-cooks.distance(modelo1)
h<-influence(modelo1)$hat
datos_aug<-datos
datos_aug$CD<-NA
datos_aug$h<-NA
datos_aug[-ix_vl,"CD"]<-CD
datos_aug[-ix_vl,"h"]<-h
```


```{r}
popup<-paste0("Edad: ",format(datos_aug$X2[-ix_vl],digits = 2),
              "<br>",
              "Dist MRT: ",format(datos_aug$X2[-ix_vl],digits = 2),
              "<br>",
              "# Tiendas: ",format(datos_aug$X3[-ix_vl],digits = 2),
              "<br>",
              "Precio: ", format(datos_aug$Y,digits=2),
              "<br>",
              "h: ",format(datos_aug$h,digits=2))
colorh<-ifelse(datos_aug$h>0.04 & !is.na(datos_aug$h),"#FF6666","#FFFF66")
mapa<-leaflet()
mapa<-addTiles(mapa)
# mapa<-addTiles(mapa,urlTemplate="https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png",
#                attribution="<a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
#                )
mapa<-addCircleMarkers(mapa,lat=datos_aug$X5[-ix_vl],lng = datos_aug$X6[-ix_vl],popup = popup,
                       color=colorh,
                        options=markerOptions(opacity = 0.3))
mapa
```

¿Dónde es más caro el precio de la propiedad?

```{r}
mapa_p<-leaflet(data=datos)
mapa_p<-addTiles(mapa_p)
# mapa_p<-addTiles(mapa_p,urlTemplate="https://tiles.stadiamaps.com/tiles/osm_bright/{z}/{x}/{y}{r}.png",
#                attribution="<a href='https://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors"
#                )
mapa_p<-addHeatmap(mapa_p,lat=~X5,lng=~X6,intensity = ~Y^(-0.8),max=0.5,blur=20,radius=12)

mapa_p
```

<h1 style="text-align: right;"><a href="codigo_clase.html"><span style="color: #000000; font-size: 14pt;"><strong> Segunda práctica</strong></span></a></h1>